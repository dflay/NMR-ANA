# Project name
PROJECT = nmr_ana 

# Directories
OBJDIR = obj
SODIR  = slib  
SRCDIR = src
INCDIR = include 

# Compiler
CC       = g++
CPPFLAGS = -Wall -I$(INCDIR) -O2 -fPIC -g  \
       -Wmissing-declarations -Wreturn-type -Wunused \
       -Wcomment -Wformat

# shared object 
LDFLAGS = -shared  

# Libraries
LIBS       = -lm
TARGET_LIB = NMRANA.so 
 
# sources 
SRCDIRS = $(shell find $(SRCDIR) -type d | sed 's/$(SRCDIR)/./g' )
SRCS    = $(SRCDIR)/NMRAnalysis.cpp         \
          $(SRCDIR)/NMRRun.cpp              \
          $(SRCDIR)/NMRPulse.cpp            \
          $(SRCDIR)/NMRPulseAnalyzed.cpp    \
          $(SRCDIR)/NMRFileManager.cpp      \
          $(SRCDIR)/NMRInputManager.cpp     \
          $(SRCDIR)/NMRMath.cpp             \
          $(SRCDIR)/NMRZeroCrossing.cpp     \
          $(SRCDIR)/NMRUtility.cpp          \
          $(SRCDIR)/NMRFourierTransform.cpp 
# objects 
OBJS    = $(patsubst $(SRCDIR)/%.cpp,$(OBJDIR)/%.o,$(SRCS))

all: $(TARGET_LIB) 

# build a shared library, move to the lib dir, then build the main program 
$(TARGET_LIB): buildrepo $(OBJS)
	$(CC) $(CFLAGS) $(OBJS) -o $@ $(LDFLAGS) 
	mv $(TARGET_LIB) $(SODIR) 
	$(CC) -o $(PROJECT) $(SRCDIR)/main.cpp -I$(INCDIR) -L$(SODIR) -l$(TARGET_LIB)

# make objects
$(OBJDIR)/%.o: $(SRCDIR)/%.cpp
	$(CC) $(CPPFLAGS) -c $< -o $@

.PHONY: clean
clean:
	rm -Rf $(PROJECT) $(OBJDIR) $(SODIR) $(SRCDIR)/*~  *~ 

buildrepo:
	@$(call make-repo)

# Create obj directory structure
define make-repo
	for dir in $(SRCDIRS); \
	do \
	mkdir -p $(OBJDIR)/$$dir; \
	mkdir -p $(SODIR)/$$dir; \
	done
endef

